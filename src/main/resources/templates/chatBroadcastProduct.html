<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Chat Broadcast Product</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>



</head>
<body>

<div th:insert = "~{common/header :: header}"></div>

<input type="hidden" th:value="${mb_nick}" id="mb_nick"/>
<input type="hidden" th:value="${mb_name}" id="mb_name"/>
<input type="hidden" th:value="${mb_no}" id="mb_no"/>

<div class="chatbox" style="width:50%;" align="center">
  <!-- 채팅 내용 -->
  <div id="content">
    <div th:each="chatRoom : ${chatHistory}">
      <th:block th:if="${chatRoom.senderName == mb_name}">
        <div class="chatbox_messages">
          <div class="chatbox_messageBox" style="text-align:right">
            <div class="chatRoomSenderName" th:text="${chatRoom.senderName}"></div>
            <div class="chatbox_message chatRoomContent" th:text="${chatRoom.content}"></div>
            <div class="chatRoomSendTime" th:text="${#strings.substring(chatRoom.sendTime, 0, 6)}"></div>
          </div>
        </div>
      </th:block>
      
      <th:block th:if="${chatRoom.senderName != mb_name}">
        <div class="chatbox_messages">
          <div class="chatbox_messageBox" style="text-align:left">
            <div class="chatRoomSenderName" th:text="${chatRoom.senderName}"></div>
            <div class="chatbox_message chatRoomContent" th:text="${chatRoom.content}"></div>
            <div class="chatRoomSendTime" th:text="${#strings.substring(chatRoom.sendTime, 0, 6)}"></div>
          </div>
        </div>
      </th:block>
    </div>
  </div>
  <!-- 채팅 내용 끝 -->
</div>
<!-- Footer 고정 Nav 버튼 -->
<footer style="width:50%;" align="center;">
  <div class="chatbox_inputPanel">
    <input type="text" id="message" class="chatbox_input" placeholder="메세지를 입력해주세요">
    <div class="chatbox__tooltip chatbox__tooltip--bottom">
      <button id="send_btn" class="btn chatbox_button w3-theme" style="padding:0.375rem;" th:onclick="'send()'" th:text="전송하기"><i class="fa fa-paper-plane fa-lg" aria-hidden="true"></i></button>
    </div>

    <input type="hidden" th:value="${chatRoomInfo.mb_nick_a}" id="mb_nick_a" />
    <input type="hidden" th:value="${chatRoomInfo.mb_name_a}" id="mb_name_a" />
    <input type="hidden" th:value="${chatRoomInfo.id}" id="id" />
    <input type="hidden" th:value="${chatRoomInfo.mb_nick_b}" id="mb_nick_b" />
    <input type="hidden" th:value="${chatRoomInfo.mb_name_b}" id="mb_name_b" />
  </div>
</footer>
</body>

<div th:insert = "~{common/footer :: footer}"></div>

<script type="text/javascript">
	
	function scroll_go(){

		$('html, body').scrollTop( $(document).height() );
	}
	
	$( document ).ready(function() {
		scroll_go();
    });
	
	var mb_nick = $('#mb_nick').val();
	var user_type = $('#user_type').val();
		var stompClient = null;
		var mb_nick_a = $('#mb_nick_a').val();
		var mb_name_a = $('#mb_name_a').val();
		var mb_name_b = $('#mb_name_b').val();
		var id = $('#id').val();
		var mb_nick_b = $('#mb_nick_b').val();	
		var senderName = $('#mb_name').val();
		var senderId = $('#mb_no').val();
		
		$(document).ready(connect());
		$(document).ready(ajaxChatRead(mb_nick));
		
		function connect() {
        console.log("커넥트");
			var socket = new SockJS('/broadcast');
			var url = '/topic/' + id + '/queue/messages';

				stompClient = Stomp.over(socket);

				stompClient.connect({}, function() {

					stompClient.subscribe(url, function(output) {

						showBroadcastMessage(createTextNode(JSON.parse(output.body)));

					});
					}, 

							function (err) {
								alert('안돼!! : ' + err);
				});
		
		};

		function sendBroadcast(json) {
		console.log("샌드 브로드캐스트 제이슨");
			stompClient.send("/app/broadcast", {}, JSON.stringify(json));
			
		}
		

		function send() {

		var content_origin = $('#message').val();
			var content = content_origin.replace(/(<([^>]+)>)/ig,"");
			sendBroadcast({
				'id': id,
				'content': content,
				'mb_name_a': mb_name_a,
				'mb_name_b': mb_name_b,
				'mb_nick_a': mb_nick_a,
				'mb_nick_b': mb_nick_b,
				'senderName': senderName,
				'senderNick': mb_nick
				});
			$('#message').val("");
		}

		var inputMessage = document.getElementById('message'); 
		inputMessage.addEventListener('keyup', function enterSend(event) {
			
			if (event.keyCode === null) {
				event.preventDefault();
			}
			
			if (event.keyCode === 13) {
				send();
			}
		});

		function createTextNode(messageObj) {
			
			let mb_name = $("#mb_name").val();
			
			var origin_time = messageObj.sendTime;
			var time = origin_time.substring(0,5);

			if (mb_name == messageObj.senderName){
				return '<div class="chatbox_messages"><div class="chatbox_messageBox" style="text-align: right" class="chatRoomSenderName"><div>' +
	            messageObj.senderName +            
	            '</div><div class="chatbox_message" class="chatRoomContent">' +
	            messageObj.content+
	            '</div><div class="chatRoomSendTime">' +
	            time +
	            '</div></div></div>';	
			} else {
				return '<div class="chatbox_messages"><div class="chatbox_messageBox" style="text-align: left" class="chatRoomSenderName"><div>' +
	            messageObj.senderName +            
	            '</div><div class="chatbox_message" class="chatRoomContent">' +
	            messageObj.content+
	            '</div><div class="chatRoomSendTime">' +
	            time +
	            '</div></div></div>';
			}
        }


		function showBroadcastMessage(message) {
            $("#content").html($("#content").html() + message);
            scroll_go();
        }
		

		function ajaxChatRead(reader) {

			var flag = "";
			if (reader == mb_nick_a) {
				flag = "mb_nick_a";
			} else {
				flag = "mb_nick_b";
			}

			$.ajax({
				url:'/chatread/product/ajax',
				type: 'POST',
				data: JSON.stringify({
					id: id,
					flag: flag
				}),
				dataType: 'json',
				contentType: 'application/json'
			})

		}

	
	</script>

</html>
